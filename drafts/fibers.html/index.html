<!DOCTYPE html>
<html lang="en-us">
<head>
  <title>Lightweight fibres for TruffleRuby. - aardvark179.github.io</title>
  <meta charset="utf-8" />
  <meta name="author" content="" />

  <link rel="alternate" title="RSS Feed" href="/rss.xml" type="application/rss+xml">
  <link rel="stylesheet" href="/media/css/main.css" type="text/css">
  <link rel="stylesheet" href="/media/css/posts.css" type="text/css">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <script src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
</head>

  <body class="container">
<header id="header">
    <body>
        <nav class="navbar navbar-default navbar-fixed-top" style="opacity: .9" role="navigation">
            <div class="container-fluid">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="/">aardvark179.github.io</a>
                </div>
                <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                    <ul class="nav navbar-nav navbar-right">
                            <li class="active"><a href="/blog/">Blog</a></li>
                            <li class="active"><a href="/drafts/">Drafts</a></li>
                        <li><a href="/tags/">Tags</a></li>
                        <li><a href="/about/">About</a></li>
                        <li><a href="https://github.com/aardvark179">GitHub</a></li>
                        <li><a href="/rss.xml">RSS</a></li>
                    </ul>
                </div>
            </div>
        </nav>
    </body>
</header>

<section id="content" role="main">
    <div id="outline-container-sec-" class="row" style="padding-top: 70px">
        <div class="col-md-2"></div>
            <h1>Lightweight fibres for TruffleRuby.</h1>
            <div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org79e7a7f">1. Disclaimer</a></li>
<li><a href="#org8dd7126">2. Lightweight threads, continuations, and Project Loom.</a>
<ul>
<li><a href="#org822e8f0">2.1. Lightweight user mode threads</a></li>
<li><a href="#org6b58efd">2.2. Continuations</a></li>
<li><a href="#orgc25178c">2.3. What makes these features more light weight than <code>java.lang.Thread</code>?</a></li>
</ul>
</li>
<li><a href="#orgcf4e94a">3. Fibers and continuations in Ruby</a>
<ul>
<li><a href="#orge181a77">3.1. Fibers</a></li>
<li><a href="#org303db37">3.2. Continuations</a></li>
</ul>
</li>
<li><a href="#orge01eae5">4. The differences between these two models</a></li>
<li><a href="#orga44db9f">5. Implementing Ruby's model using Loom's</a>
<ul>
<li><a href="#org2584122">5.1. Implementing fibres</a>
<ul>
<li><a href="#orge37b11f">5.1.1. With Loom's Fibers</a></li>
<li><a href="#org95b4a78">5.1.2. With Loom's Continuations</a></li>
</ul>
</li>
<li><a href="#orgad46447">5.2. Implementing <code>callcc</code></a></li>
</ul>
</li>
</ul>
</div>
</div>
<p>
The MRI Ruby implementation supports heavy weight threads which are
pre-emptively scheduled, and lightweight fibres which may run on those
threads and are co-operatively scheduled. Fibres have been a problem
for JVM Ruby implementations because the VM itself did not have a
concept of a fibre, or a lightweight abstraction we could build upon,
but that's starting to change with <a href="http://openjdk.java.net/projects/loom/">Project loom</a>, let's take a look at
what it gives, and how we can use that to implement fibres that can
scale beyond even MRI's.
</p>
<div id="outline-container-org79e7a7f" class="outline-2">
<h2 id="org79e7a7f"><span class="section-number-2">1</span> Disclaimer</h2>
<div class="outline-text-2" id="text-1">
<p>
Everything I"m talking about here is based on early prototypes. The
APIs and features may change radically before anything nears being
production, and there is no fixed timetable for when these feature
will arrive in a production JVM except, "When it's done."
</p>
</div>
</div>
<div id="outline-container-org8dd7126" class="outline-2">
<h2 id="org8dd7126"><span class="section-number-2">2</span> Lightweight threads, continuations, and Project Loom.</h2>
<div class="outline-text-2" id="text-2">
<p>
Project Loom is an OpenJDK project with the goal
</p>
<blockquote>
<p>
To explore and incubate Java VM features and APIs built on top of them
for the implementation of lightweight user-mode threads (fibers),
delimited continuations (of some form), and related features, such as
explicit tail-call.
</p>
</blockquote>
<p>
That may sound complex, but let's look at it bit by bit and see what
it gives us in Java, and how we can use that in TruffleRuby.
</p>
</div>
<div id="outline-container-org822e8f0" class="outline-3">
<h3 id="org822e8f0"><span class="section-number-3">2.1</span> Lightweight user mode threads</h3>
<div class="outline-text-3" id="text-2-1">
<p>
These are currently called <code>java.lang.Fiber</code> in the project loom
prototype, and they provide a nice simple model. Fibres are started
with a scheduler, and whenever the has nothing to do it parks
itself. When the scheduler decided that that fibre has more work it
can do then it will schedule it next. The scheduler isn't special,
it's a standard <code>java.util.concurrent.Executor</code> and it can use
whatever scheduling strategy it likes, across as many threads as it
likes. If your fibres are mostly doing IO, or waiting for locks then
you probably won't even have to park them explicitly as the Java class
library will do that for you.
</p>
</div>
</div>
<div id="outline-container-org6b58efd" class="outline-3">
<h3 id="org6b58efd"><span class="section-number-3">2.2</span> Continuations</h3>
<div class="outline-text-3" id="text-2-2">
<p>
Continuations are a lower level concept upon which those lightweight
threads are built. A continuation can be run, and can yield control
back to the function which ran it. If it is run again then it will
continue from the point at which it yielded with roughly the same call
stack, local variables, and so forth.
</p>
</div>
</div>
<div id="outline-container-orgc25178c" class="outline-3">
<h3 id="orgc25178c"><span class="section-number-3">2.3</span> What makes these features more light weight than <code>java.lang.Thread</code>?</h3>
</div>
</div>
<div id="outline-container-orgcf4e94a" class="outline-2">
<h2 id="orgcf4e94a"><span class="section-number-2">3</span> Fibers and continuations in Ruby</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-orge181a77" class="outline-3">
<h3 id="orge181a77"><span class="section-number-3">3.1</span> Fibers</h3>
</div>
<div id="outline-container-org303db37" class="outline-3">
<h3 id="org303db37"><span class="section-number-3">3.2</span> Continuations</h3>
</div>
</div>
<div id="outline-container-orge01eae5" class="outline-2">
<h2 id="orge01eae5"><span class="section-number-2">4</span> The differences between these two models</h2>
</div>
<div id="outline-container-orga44db9f" class="outline-2">
<h2 id="orga44db9f"><span class="section-number-2">5</span> Implementing Ruby's model using Loom's</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-org2584122" class="outline-3">
<h3 id="org2584122"><span class="section-number-3">5.1</span> Implementing fibres</h3>
<div class="outline-text-3" id="text-5-1">
</div>
<div id="outline-container-orge37b11f" class="outline-4">
<h4 id="orge37b11f"><span class="section-number-4">5.1.1</span> With Loom's Fibers</h4>
</div>
<div id="outline-container-org95b4a78" class="outline-4">
<h4 id="org95b4a78"><span class="section-number-4">5.1.2</span> With Loom's Continuations</h4>
</div>
</div>
<div id="outline-container-orgad46447" class="outline-3">
<h3 id="orgad46447"><span class="section-number-3">5.2</span> Implementing <code>callcc</code></h3>
</div>
</div>

    </div>
</section>


<footer class="footer">
    <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 26.x (<a href="http://orgmode.org">Org mode</a> 9.x)</p>
    <p>
        Copyright &copy; 2012 - <span id="footerYear"></span> <a href="mailto:duncan &lt;at&gt; duncan-linux"></a>
        &nbsp;&nbsp;-&nbsp;&nbsp;
        Powered by <a href="https://github.com/kelvinh/org-page" target="_blank">org-page</a>
        <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
    </p>
</footer>

  </body>
</html>
